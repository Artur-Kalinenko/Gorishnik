{% extends "base.html" %}
{% load static %}

{% block title %}
    {{ assortment.assortment_name }}
{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <!-- –ö–∞—Ä—Ç–∏–Ω–∫–∞ -->
        <div class="col-md-6">
            {% if assortment.poster %}
                <img src="{{ assortment.poster.url }}" class="img-fluid" alt="{{ assortment.assortment_name }}">
            {% else %}
                <img src="{% static 'images/default.jpg' %}" class="img-fluid" alt="No image available">
            {% endif %}
        </div>

        <!-- –ò–Ω—Ñ–æ –æ —Ç–æ–≤–∞—Ä–µ -->
        <div class="col-md-6">
            <h1 class="montserrat-category-title">{{ assortment.assortment_name }}</h1>
            <p><strong>–ö–∞—Ç–µ–≥–æ—Ä—ñ—ó:</strong>
                {% for cat in assortment.categories.all %}
                    {{ cat.category }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
            </p>
            <p><strong>–í–∏—Ä–æ–±–Ω–∏–∫:</strong> {{ assortment.producer.producer_name }}</p>
            <p><strong>–ù–∞—è–≤–Ω—ñ—Å—Ç—å:</strong> {{ assortment.is_available|yesno:"–£ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ,–ù–µ–º–∞ —É –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ" }}</p>
            <p><strong>–û–ø–∏—Å –ø—Ä–æ–¥—É–∫—Ç—É:</strong></p>
            <p>{{ assortment.assortment_description }}</p>

            <!-- –¶—ñ–Ω–∞ -->
            <p class="card-text">
                <strong id="price-display">
                    {% if variants.exists %}
                        {% with sorted_variants=variants|dictsort:"price" %}
                            {% with min=sorted_variants.0.price %}
                                {% with sorted_variants|last as last_variant %}
                                    {% if min != last_variant.price %}
                                        {{ min }} ‚Ç¥ ‚Äì {{ last_variant.price }} ‚Ç¥
                                    {% else %}
                                        {{ min }} ‚Ç¥
                                    {% endif %}
                                {% endwith %}
                            {% endwith %}
                        {% endwith %}
                    {% else %}
                        {{ assortment.price }} ‚Ç¥
                    {% endif %}
                </strong>
            </p>

            <!-- üè∑ –ú—ñ—Ç–∫–∏ -->
            {% if assortment.tags.exists %}
                <div class="mt-2">
                    {% for tag in assortment.tags.all %}
                        <span class="badge bg-success me-1">{{ tag.name }}</span>
                    {% endfor %}
                </div>
            {% endif %}

            <!-- –í–∞—Ä–∏–∞–Ω—Ç—ã -->
            {% if variants.exists %}
                <div class="mb-3">
                    {% for variant in variants %}
                        <button class="btn btn-outline-secondary grams-button btn-sm"
                                data-price="{{ variant.price }} ‚Ç¥">
                            {{ variant.grams }}–≥
                        </button>
                    {% endfor %}
                </div>
            {% else %}
                <p class="card-text">{{ assortment.grams }}–≥</p>
            {% endif %}
        </div>
    </div>

    <hr>

    <!-- ‚≠ê –°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥ -->
    <h4>–†–µ–π—Ç–∏–Ω–≥:</h4>
    <p>
        {% with avg=assortment.average_rating %}
            {% for _ in "12345" %}
                {% if forloop.counter <= avg %}
                    ‚≠ê
                {% elif forloop.counter <= avg|floatformat:1 %}
                    ‚≠êÔ∏è
                {% else %}
                    ‚òÜ
                {% endif %}
            {% endfor %}
            ({{ avg|floatformat:1 }} / 5)
        {% endwith %}
    </p>

    <!-- üí¨ –û—Ç–∑—ã–≤—ã -->
    <h5 class="mt-4">–í—ñ–¥–≥—É–∫–∏:</h5>
    {% if reviews %}
        {% for review in reviews %}
            <div class="border rounded p-2 mb-2">
                <strong>{{ review.user.first_name|default:review.user.email }}</strong>
                <span class="text-muted">‚Äî {{ review.created_at|date:"d.m.Y H:i" }}</span><br>
                <span>
                    {% for _ in "12345" %}
                        {% if forloop.counter <= review.rating %}
                            ‚≠ê
                        {% else %}
                            ‚òÜ
                        {% endif %}
                    {% endfor %}
                </span>
                {% if review.comment %}
                    <p>{{ review.comment }}</p>
                {% endif %}

                {% if user.is_authenticated and review.user == user %}
                    <div class="mt-2">
                        {% if edit_mode and edit_review.id == review.id %}
                            <!-- üîß –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
                            <form method="post">
                                {% csrf_token %}
                                <input type="hidden" name="edit_review_id" value="{{ review.id }}">
                                {{ form.as_p }}
                                <button type="submit" class="btn btn-sm btn-primary">–û–Ω–æ–≤–∏—Ç–∏</button>
                                <a href="{% url 'assortment_detail' assortment.id %}" class="btn btn-sm btn-secondary">–°–∫–∞—Å—É–≤–∞—Ç–∏</a>
                            </form>
                        {% else %}
                            <a href="?edit={{ review.id }}" class="btn btn-sm btn-outline-primary me-2">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</a>
                            <a href="{% url 'delete_review' review.id %}" class="btn btn-sm btn-outline-danger"
                               onclick="return confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –≤—ñ–¥–≥—É–∫?');">–í–∏–¥–∞–ª–∏—Ç–∏</a>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        {% endfor %}
    {% else %}
        <p>–ù–µ–º–∞—î –≤—ñ–¥–≥—É–∫—ñ–≤.</p>
    {% endif %}

    <!-- üìù –§–æ—Ä–º–∞ –¥–ª—è –∑–∞–ª–∏—à–µ–Ω–Ω—è –≤—ñ–¥–≥—É–∫—É -->
    {% if user.is_authenticated and not user_review %}
        <hr>
        <h5 class="mt-4">–ó–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫:</h5>
        <form method="post">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit" class="btn btn-primary">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
        </form>
    {% elif user_review and edit_mode == False %}
        <div class="alert alert-info mt-4">–í–∏ –≤–∂–µ –∑–∞–ª–∏—à–∞–ª–∏ –≤—ñ–¥–≥—É–∫.</div>
    {% elif not user.is_authenticated %}
        <div class="alert alert-warning mt-4">–©–æ–± –∑–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫, —É–≤—ñ–π–¥—ñ—Ç—å –¥–æ –∞–∫–∞—É–Ω—Ç—É.</div>
    {% endif %}
</div>

<script src="{% static 'assortment/assortment_detail.js' %}"></script>
{% endblock %}
