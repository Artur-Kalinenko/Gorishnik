{% load dict_extras %}

<form method="get" id="filter-form">
    {% if selected_category %}
        <input type="hidden" name="category" value="{{ selected_category }}">
    {% endif %}
    {% if query %}
        <input type="hidden" name="q" value="{{ query }}">
    {% endif %}

    {% if active_producers %}
        <div class="filter-group mb-3">
            <h5 class="filter-header">–í–∏—Ä–æ–±–Ω–∏–∫–∏</h5>
            <div class="d-flex flex-wrap gap-2">
                {% for producer in active_producers %}
                    {% if producer.id|stringformat:"s" in selected_producer_ids %}
                        <label class="producer-label producer-label--selected">
                            <input type="checkbox" name="producer" value="{{ producer.id }}"
                                   class="d-none"
                                   checked>
                            <img src="{{ producer.producer_img.url }}"
                                 alt="{{ producer.producer_name }}"
                                 class="producer-img">
                        </label>
                    {% else %}
                        <label class="producer-label">
                            <input type="checkbox" name="producer" value="{{ producer.id }}"
                                   class="d-none">
                            <img src="{{ producer.producer_img.url }}"
                                 alt="{{ producer.producer_name }}"
                                 class="producer-img">
                        </label>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    {% endif %}

    <!-- üîΩ –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
    <div class="filter-group mb-3">
        <h5 class="filter-header">–î–æ–¥–∞—Ç–∫–æ–≤–æ</h5>
        <div class="filter-options">
            <label class="form-check mb-1">
                <input class="form-check-input" type="checkbox" name="new" value="1" {% if request.GET.new %}checked{% endif %}>
                <span class="custom-checkbox"></span>
                <span class="form-check-label">–ù–æ–≤–∏–Ω–∫–∏</span>
            </label>
            {% if user.is_authenticated %}
                <label class="form-check mb-1">
                    <input class="form-check-input" type="checkbox" name="my_favorites" value="1" {% if request.GET.my_favorites == "1" %}checked{% endif %}>
                    <span class="custom-checkbox"></span>
                    <span class="form-check-label">–ú–æ—ó –æ–±—Ä–∞–Ω—ñ —Ç–æ–≤–∞—Ä–∏</span>
                </label>
            {% endif %}
        </div>
    </div>

    <!-- üîΩ –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –≥—Ä—É–ø–ø–∞–º -->
    {% for group in filter_groups %}
        <div class="filter-group mb-3">
            <h5 class="filter-header d-flex justify-content-between align-items-center"
                data-group-id="{{ group.id }}" style="cursor: pointer;">
                {{ group.name }}
                <span class="toggle-icon" id="icon-{{ group.id }}">+</span>
            </h5>

            {# –°–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫ —Å –æ–ø—Ü–∏—è–º–∏ –≥—Ä—É–ø–ø—ã, –ø–æ–∫–∞ –æ–Ω ¬´—Å–≤–µ—Ä–Ω—É—Ç¬ª #}
            <div class="filter-options" id="group-{{ group.id }}" style="display: none;">
                {# –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ ¬´–¥–æ—Å—Ç—É–ø–Ω—ã–µ¬ª –æ–ø—Ü–∏–∏ #}
                {% for option in group.options.all %}
                    {% with count=option_counts|get_item:option.id %}
                        {% if count == 0 and not option.id in selected_filter_ids %}
                            {# ¬´–ù–µ–¥–æ—Å—Ç—É–ø–Ω–∞—è¬ª –æ–ø—Ü–∏—è: –ø—Ä—è—á–µ–º –µ—ë —Å –ø–æ–º–æ—â—å—é –∫–ª–∞—Å—Å–æ–≤ unavailable + hidden #}
                            <label class="form-check mb-1 unavailable hidden">
                                <input class="form-check-input"
                                       type="checkbox"
                                       name="filters"
                                       value="{{ option.id }}"
                                       disabled>
                                <span class="custom-checkbox"></span>
                                <span class="form-check-label">
                                    {{ option.name }} ({{ count|default:0 }})
                                </span>
                            </label>
                        {% else %}
                            {# ¬´–î–æ—Å—Ç—É–ø–Ω–∞—è¬ª –∏–ª–∏ —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω–∞—è –æ–ø—Ü–∏—è: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫ –æ–±—ã—á–Ω–æ #}
                            <label class="form-check mb-1">
                                <input class="form-check-input"
                                       type="checkbox"
                                       name="filters"
                                       value="{{ option.id }}"
                                       {% if option.id in selected_filter_ids %}checked{% endif %}>
                                <span class="custom-checkbox"></span>
                                <span class="form-check-label">
                                    {{ option.name }} ({{ count|default:0 }})
                                </span>
                            </label>
                        {% endif %}
                    {% endwith %}
                {% endfor %}

                {# –ö–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑–∞—Ç—å ¬´–Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–µ¬ª –æ–ø—Ü–∏–∏, –µ—Å–ª–∏ —Ç–∞–∫–∏–µ –≤–æ–æ–±—â–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç #}
                <button type="button"
                        class="btn btn-link btn-sm show-unavailable"
                        data-group-id="{{ group.id }}">
                    –ü–æ–∫–∞–∑–∞—Ç–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ —Ñ—ñ–ª—å—Ç—Ä–∏
                </button>
            </div>
        </div>
    {% endfor %}

    <button type="button" id="clear-filters" class="btn btn-outline-danger mt-4">
        –û—á–∏—Å—Ç–∏—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏
    </button>
</form>

